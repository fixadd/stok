{% extends "layout.html" %}

{% block title %}Stok Takip · Stok Yönetim Paneli{% endblock %}

{% block main %}
<div class="d-flex flex-column gap-4">
  <section class="content-card shadow-sm">
    <div class="stock-header">
      <div>
        <h1 class="h3 fw-bold mb-1">Stok Yönetimi</h1>
        <p class="text-muted mb-0">Donanım, yazıcı ve lisans stok hareketlerini izleyin, hızlı aksiyon alın.</p>
      </div>
      <div class="stock-toolbar">
        <button class="btn btn-primary d-flex align-items-center gap-2" type="button" data-bs-toggle="modal" data-bs-target="#stockCreateModal">
          <i class="bi bi-plus-lg"></i>
          Ekle
        </button>
        <button class="btn btn-warning stock-faulty-button d-flex align-items-center gap-2" type="button">
          <i class="bi bi-exclamation-triangle"></i>
          Arızalı Durum
          <span class="stock-faulty-counter">{{ stock_faulty_count }}</span>
        </button>
        <button class="btn btn-outline-secondary d-flex align-items-center gap-2" type="button" id="stockHistoryToggle">
          <i class="bi bi-archive"></i>
          Stok Dışı
        </button>
        <div class="btn-group">
          <button class="btn btn-outline-primary d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-file-earmark-spreadsheet"></i>
            Excel
          </button>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm">
            <li><button class="dropdown-item" type="button"><i class="bi bi-box-arrow-up"></i> Dışa Aktar</button></li>
            <li><button class="dropdown-item" type="button"><i class="bi bi-box-arrow-in-down"></i> İçe Aktar</button></li>
          </ul>
        </div>
      </div>
      <div class="stock-search">
        <div class="input-group search-input">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control" id="stockSearchInput" type="search" placeholder="Ara">
        </div>
      </div>
    </div>
  </section>

  <section class="content-card shadow-sm">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
      <ul class="nav nav-tabs stock-tabs" id="stockViewTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="stock-status-tab" data-bs-toggle="tab" data-bs-target="#stockStatusPane" type="button" role="tab" aria-controls="stockStatusPane" aria-selected="true">Stok Durumu</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stock-log-tab" data-bs-toggle="tab" data-bs-target="#stockLogPane" type="button" role="tab" aria-controls="stockLogPane" aria-selected="false">Log</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stock-users-tab" data-bs-toggle="tab" data-bs-target="#stockUsersPane" type="button" role="tab" aria-controls="stockUsersPane" aria-selected="false">Kullanıcılar</button>
        </li>
      </ul>
      <div class="stock-status-summary d-flex flex-wrap gap-3">
        {% for summary in stock_status_summary %}
        <div class="stock-summary-chip">
          <span class="stock-summary-count">{{ summary.count }}</span>
          <span class="stock-summary-label">{{ summary.label }}</span>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="tab-content pt-4" id="stockViewTabContent">
      <div class="tab-pane fade show active" id="stockStatusPane" role="tabpanel" aria-labelledby="stock-status-tab">
        <div class="stock-category-filters d-flex flex-wrap gap-2 mb-4" id="stockCategoryFilters">
          <input class="btn-check" type="radio" name="stockCategory" id="stockCategoryAll" value="all" checked>
          <label class="btn btn-outline-primary" for="stockCategoryAll">
            Tümü
            <span class="badge bg-light text-dark">{{ stock_items | length }}</span>
          </label>
          {% for category in stock_categories %}
          <input class="btn-check" type="radio" name="stockCategory" id="stockCategory{{ loop.index }}" value="{{ category.value }}">
          <label class="btn btn-outline-primary" for="stockCategory{{ loop.index }}">
            {{ category.label }}
            <span class="badge bg-light text-dark">{{ category.count }}</span>
          </label>
          {% endfor %}
        </div>

        <div class="alert stock-action-alert d-none" id="stockActionAlert" role="alert"></div>

        <div class="table-responsive">
          <table class="table align-middle stock-table" id="stockTable" data-paginate data-page-size="20" data-paginate-items="tbody tr">
            <thead>
              <tr>
                <th scope="col">Donanım Tipi</th>
                <th scope="col">Kategori</th>
                <th scope="col">Miktar</th>
                <th scope="col">Kaynak</th>
                <th scope="col">Durum</th>
                <th scope="col">Tarih</th>
                <th scope="col" class="text-end">İşlemler</th>
              </tr>
            </thead>
            <tbody>
              {% for item in stock_items %}
              <tr class="stock-row" data-stock-id="{{ item.id }}" data-category="{{ item.category }}" data-status="{{ item.status }}" data-search="{{ item.search_index }}">
                <td>
                  {% set hardware_label = item.hardware_type or item.title %}
                  <div class="fw-semibold">{{ hardware_label }}</div>
                  {% set details = namespace(values=[]) %}
                  {% set brand_model = (item.brand ~ ' ' ~ item.model)|trim %}
                  {% if brand_model %}
                    {% set _ = details.values.append(brand_model) %}
                  {% elif item.title and item.title != (item.hardware_type or '') %}
                    {% set _ = details.values.append(item.title) %}
                  {% endif %}
                  {% if item.inventory_no %}
                    {% set _ = details.values.append(item.inventory_no) %}
                  {% endif %}
                  <div class="text-muted small">
                    {% if details.values %}
                      {{ details.values | join(' • ') }}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </td>
                <td>
                  <span class="badge bg-soft-primary text-primary">{{ item.category_label }}</span>
                </td>
                <td>
                  <div class="fw-semibold">{{ item.quantity }}</div>
                  <div class="text-muted small">{{ item.unit }}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ item.source_label }}</div>
                  {% if item.metadata.factory %}
                  <div class="text-muted small">{{ item.metadata.factory }}</div>
                  {% endif %}
                </td>
                <td>
                  <span class="stock-status-badge {{ item.status_class }}">{{ item.status_label }}</span>
                </td>
                <td>
                  <div class="fw-semibold">{{ item.created_display }}</div>
                  <div class="text-muted small">{{ item.updated_display }}</div>
                </td>
                <td class="text-end">
                  <div class="table-actions">
                    <button class="btn btn-outline-secondary btn-sm icon-button stock-detail-trigger" type="button" data-stock-id="{{ item.id }}" aria-label="Stok detayını görüntüle">
                      <i class="bi bi-eye"></i>
                    </button>
                    <div class="dropdown action-dropdown">
                      <button class="btn btn-outline-secondary btn-sm action-dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        İşlemler
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                        <li>
                          <button class="dropdown-item stock-action" type="button" data-action="assign" data-stock-id="{{ item.id }}" {% if not item.allow_operations %}disabled{% endif %}>
                            <i class="bi bi-person-plus"></i>
                            Atama Yap
                          </button>
                        </li>
                        <li>
                          <button class="dropdown-item stock-action" type="button" data-action="faulty" data-stock-id="{{ item.id }}" {% if not item.allow_operations %}disabled{% endif %}>
                            <i class="bi bi-bandaid"></i>
                            Arızalı İşaretle
                          </button>
                        </li>
                        <li>
                          <button class="dropdown-item text-danger stock-action" type="button" data-action="scrap" data-stock-id="{{ item.id }}" {% if not item.allow_operations %}disabled{% endif %}>
                            <i class="bi bi-calendar-x"></i>
                            Tarihten Ayır
                          </button>
                        </li>
                      </ul>
                    </div>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td class="text-center text-muted" colspan="7">Stok kaydı bulunamadı.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="alert alert-soft d-none mt-3" id="stockEmptyState">Aradığınız kriterlere uygun stok kaydı bulunamadı.</div>
      </div>

      <div class="tab-pane fade" id="stockLogPane" role="tabpanel" aria-labelledby="stock-log-tab">
        <div class="table-responsive">
          <table class="table align-middle" id="stockLogTable" data-paginate data-page-size="20" data-paginate-items="tbody tr">
            <thead>
              <tr>
                <th scope="col">İşlem</th>
                <th scope="col">Kullanıcı</th>
                <th scope="col">Stok</th>
                <th scope="col">Durum</th>
                <th scope="col">Tarih</th>
                <th scope="col">Not</th>
              </tr>
            </thead>
            <tbody>
              {% for log in stock_logs %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ log.action }}</div>
                </td>
                <td>{{ log.performed_by or '—' }}</td>
                <td>
                  <div class="fw-semibold">{{ log.title or '—' }}</div>
                  {% if log.metadata.inventory_no %}
                  <div class="text-muted small">{{ log.metadata.inventory_no }}</div>
                  {% endif %}
                </td>
                <td>
                  <span class="stock-status-badge {{ log.status_class }}">{{ log.status_label }}</span>
                </td>
                <td>{{ log.created_display }}</td>
                <td>{{ log.note or '—' }}</td>
              </tr>
              {% else %}
              <tr>
                <td class="text-center text-muted" colspan="6">Henüz log kaydı bulunmuyor.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="tab-pane fade" id="stockUsersPane" role="tabpanel" aria-labelledby="stock-users-tab">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label" for="stockUserSelect">Kullanıcı</label>
            <select class="form-select" id="stockUserSelect">
              <option value="">Kullanıcı seçin</option>
            </select>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table align-middle" id="stockUserTable" data-paginate data-page-size="20" data-paginate-items="tbody tr">
            <thead>
              <tr>
                <th scope="col">Donanım Tipi</th>
                <th scope="col">Kategori</th>
                <th scope="col">Miktar</th>
                <th scope="col">Durum</th>
                <th scope="col">Güncelleme</th>
              </tr>
            </thead>
            <tbody>
              <tr data-empty-row>
                <td class="text-muted text-center" colspan="5">Bir kullanıcı seçin.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<div class="modal fade" id="stockDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg">
      <div class="modal-header border-0 pb-0">
        <div>
          <h5 class="modal-title" data-stock-detail="title">Stok Detayı</h5>
          <p class="text-muted mb-0 small" data-stock-detail="subtitle">Seçili stok kaydının özet bilgileri.</p>
        </div>
        <button class="btn btn-light" type="button" data-bs-dismiss="modal">Kapat</button>
      </div>
      <div class="modal-body pt-3">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="stock-detail-card">
              <h6 class="text-uppercase text-muted small mb-3">Temel Bilgiler</h6>
              <dl class="row mb-0">
                <dt class="col-sm-5 text-muted small">Donanım Tipi</dt>
                <dd class="col-sm-7 fw-semibold" data-stock-detail="hardware">—</dd>
                <dt class="col-sm-5 text-muted small">Marka / Model</dt>
                <dd class="col-sm-7" data-stock-detail="brand-model">—</dd>
                <dt class="col-sm-5 text-muted small">Kategori</dt>
                <dd class="col-sm-7" data-stock-detail="category">—</dd>
                <dt class="col-sm-5 text-muted small">Miktar</dt>
                <dd class="col-sm-7" data-stock-detail="quantity">—</dd>
                <dt class="col-sm-5 text-muted small">Durum</dt>
                <dd class="col-sm-7"><span class="stock-status-badge" data-stock-detail="status">—</span></dd>
              </dl>
            </div>
          </div>
          <div class="col-md-6">
            <div class="stock-detail-card">
              <h6 class="text-uppercase text-muted small mb-3">Kaynak Bilgisi</h6>
              <dl class="row mb-0">
                <dt class="col-sm-5 text-muted small">Kaynak</dt>
                <dd class="col-sm-7" data-stock-detail="source">—</dd>
                <dt class="col-sm-5 text-muted small">Envanter No</dt>
                <dd class="col-sm-7" data-stock-detail="inventory">—</dd>
                <dt class="col-sm-5 text-muted small">Departman</dt>
                <dd class="col-sm-7" data-stock-detail="department">—</dd>
                <dt class="col-sm-5 text-muted small">Not</dt>
                <dd class="col-sm-7" data-stock-detail="note">—</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="stockCreateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="stockCreateForm">
      <div class="modal-header">
        <h5 class="modal-title">Yeni Stok Kaydı</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label" for="stockCreateTitle">Başlık</label>
          <input class="form-control" id="stockCreateTitle" name="title" type="text" required>
        </div>
        <div class="mb-3">
          <label class="form-label" for="stockCreateCategory">Kategori</label>
          <select class="form-select" id="stockCreateCategory" name="category">
            {% for category in stock_categories %}
            <option value="{{ category.value }}">{{ category.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row g-3">
          <div class="col-sm-6">
            <label class="form-label" for="stockCreateQuantity">Miktar</label>
            <input class="form-control" id="stockCreateQuantity" name="quantity" type="number" min="1" value="1">
          </div>
          <div class="col-sm-6">
            <label class="form-label" for="stockCreateUnit">Birim</label>
            <input class="form-control" id="stockCreateUnit" name="unit" type="text" placeholder="adet">
          </div>
        </div>
        <div class="mt-3" id="stockCreateMetadataSection" data-metadata-section>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0" for="stockCreateMetadataFields">Detay Bilgileri</label>
            <small class="text-muted">Kategoriye göre zorunlu alanlar</small>
          </div>
          <div class="row g-3" id="stockCreateMetadataFields"></div>
          <div class="alert alert-danger d-none mt-3" id="stockCreateMetadataError"></div>
        </div>
        <div class="mt-3">
          <label class="form-label" for="stockCreateNote">Not</label>
          <textarea class="form-control" id="stockCreateNote" name="note" rows="2" placeholder="Opsiyonel açıklama"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" type="button" data-bs-dismiss="modal">Vazgeç</button>
        <button class="btn btn-primary" type="submit">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="stockActionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form class="modal-content" id="stockActionForm">
      <div class="modal-header">
        <h5 class="modal-title" data-stock-action="title">Stok İşlemi</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3" data-stock-action="message">Seçili stok kaydı üzerinde işlem yapacaksınız.</p>
        <div class="mb-3 d-none" data-stock-action-metadata-section>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label mb-0">Atama Bilgileri</label>
            <span class="badge bg-light text-dark" data-stock-action="category"></span>
          </div>
          <div class="row g-3" data-stock-action-metadata-container></div>
          <div class="alert alert-danger d-none mt-3" data-stock-action-metadata-error></div>
        </div>
        <div class="mb-0">
          <label class="form-label" for="stockActionNote">Not (opsiyonel)</label>
          <textarea class="form-control" id="stockActionNote" name="note" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" type="button" data-bs-dismiss="modal">Vazgeç</button>
        <button class="btn btn-primary" type="submit" data-stock-action="confirm">Onayla</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const stockItems = {{ stock_items | tojson }};
  const stockLogs = {{ stock_logs | tojson }};
  const stockStatusSummary = {{ stock_status_summary | tojson }};
  const stockMetadataConfig = {{ stock_metadata_config | tojson }};
  const stockSupportOptions = {{ stock_support_options | tojson }};
  const defaultActor = {{ (active_user and (active_user.first_name ~ ' ' ~ active_user.last_name)) | default('Sistem') | tojson }};

  const bootstrapLib = window.bootstrap;
  const stockTableBody = document.querySelector('#stockTable tbody');
  const stockLogTableBody = document.querySelector('#stockLogTable tbody');
  const stockSearchInput = document.getElementById('stockSearchInput');
  const stockCategoryFilters = document.getElementById('stockCategoryFilters');
  const stockEmptyState = document.getElementById('stockEmptyState');
  const stockActionAlert = document.getElementById('stockActionAlert');
  const faultyButton = document.querySelector('.stock-faulty-button');
  const faultyCounter = document.querySelector('.stock-faulty-counter');

  const detailModalEl = document.getElementById('stockDetailModal');
  const detailModal = detailModalEl && bootstrapLib ? new bootstrapLib.Modal(detailModalEl) : null;
  const detailFields = detailModalEl
    ? {
        hardware: detailModalEl.querySelector('[data-stock-detail="hardware"]'),
        brandModel: detailModalEl.querySelector('[data-stock-detail="brand-model"]'),
        category: detailModalEl.querySelector('[data-stock-detail="category"]'),
        quantity: detailModalEl.querySelector('[data-stock-detail="quantity"]'),
        status: detailModalEl.querySelector('[data-stock-detail="status"]'),
        source: detailModalEl.querySelector('[data-stock-detail="source"]'),
        inventory: detailModalEl.querySelector('[data-stock-detail="inventory"]'),
        department: detailModalEl.querySelector('[data-stock-detail="department"]'),
        note: detailModalEl.querySelector('[data-stock-detail="note"]'),
        subtitle: detailModalEl.querySelector('[data-stock-detail="subtitle"]'),
        titleLabel: detailModalEl.querySelector('[data-stock-detail="title"]'),
      }
    : {};

  const actionModalEl = document.getElementById('stockActionModal');
  const actionModal = actionModalEl && bootstrapLib ? new bootstrapLib.Modal(actionModalEl) : null;
  const actionForm = document.getElementById('stockActionForm');
  const actionTitle = actionModalEl?.querySelector('[data-stock-action="title"]');
  const actionMessage = actionModalEl?.querySelector('[data-stock-action="message"]');
  const actionConfirmButton = actionModalEl?.querySelector('[data-stock-action="confirm"]');
  const actionNoteInput = document.getElementById('stockActionNote');
  const actionMetadataSection = actionModalEl?.querySelector('[data-stock-action-metadata-section]');
  const actionMetadataContainer = actionModalEl?.querySelector('[data-stock-action-metadata-container]');
  const actionMetadataError = actionModalEl?.querySelector('[data-stock-action-metadata-error]');
  const actionCategoryBadge = actionModalEl?.querySelector('[data-stock-action="category"]');

  const createModalEl = document.getElementById('stockCreateModal');
  const createForm = document.getElementById('stockCreateForm');
  const createTitleInput = document.getElementById('stockCreateTitle');
  const createCategorySelect = document.getElementById('stockCreateCategory');
  const createQuantityInput = document.getElementById('stockCreateQuantity');
  const createUnitInput = document.getElementById('stockCreateUnit');
  const createNoteInput = document.getElementById('stockCreateNote');
  const createMetadataSection = document.getElementById('stockCreateMetadataSection');
  const createMetadataFields = document.getElementById('stockCreateMetadataFields');
  const createMetadataError = document.getElementById('stockCreateMetadataError');

  const stockMap = new Map(stockItems.map((item) => [item.id, item]));
  let activeStockId = null;
  let showOnlyFaulty = false;
  let includeNonStock = false;
  let alertTimeoutId;
  const metadataOptionLists = new Map();
  let pendingStockAction = null;
  const pagination = window.Pagination || null;
  const stockTableEl = document.getElementById('stockTable');
  const stockLogTableEl = document.getElementById('stockLogTable');
  const historyToggle = document.getElementById('stockHistoryToggle');
  const stockUserSelect = document.getElementById('stockUserSelect');
  const stockUserTableBody = document.querySelector('#stockUserTable tbody');
  const stockUserTableEl = document.getElementById('stockUserTable');
  const userAssignments = new Map();

  function safeText(value) {
    return value && String(value).trim() ? String(value) : '—';
  }

  function getMetadataSchema(category) {
    if (!category) {
      return [];
    }
    const schema = stockMetadataConfig?.[category];
    return Array.isArray(schema) ? schema : [];
  }

  function readMetadataValues(container) {
    if (!container) {
      return {};
    }
    const values = {};
    container.querySelectorAll('[name^="metadata_"]').forEach((input) => {
      const key = input.name.replace(/^metadata_/, '');
      values[key] = input.value || '';
    });
    return values;
  }

  function ensureMetadataOptions(key) {
    if (!key) {
      return null;
    }
    if (!metadataOptionLists.has(key)) {
      const datalist = document.createElement('datalist');
      datalist.id = `metadata-options-${key}`;
      metadataOptionLists.set(key, datalist);
      document.body.appendChild(datalist);
    }
    const datalist = metadataOptionLists.get(key);
    const options = stockSupportOptions?.[key];
    if (datalist && Array.isArray(options)) {
      datalist.innerHTML = '';
      options.forEach((optionValue) => {
        const option = document.createElement('option');
        option.value = optionValue;
        datalist.appendChild(option);
      });
    }
    return datalist;
  }

  function buildMetadataForm(sectionEl, containerEl, schema, values = {}, { hidePrefilled = false, mode = 'entry' } = {}) {
    if (!sectionEl || !containerEl) {
      return;
    }
    containerEl.innerHTML = '';
    const filteredSchema = Array.isArray(schema)
      ? schema.filter((field) => {
          const assignmentOnly = Boolean(field.assignment_only);
          if (assignmentOnly && mode !== 'assignment') {
            return false;
          }
          return true;
        })
      : [];
    if (!filteredSchema.length) {
      sectionEl.classList.add('d-none');
      return;
    }
    sectionEl.classList.remove('d-none');
    filteredSchema.forEach((field) => {
      const key = field.key;
      const label = field.label || key;
      const placeholder = field.placeholder || '';
      const required = Boolean(field.required);
      const currentValue = (values[key] ?? '').toString();
      const column = document.createElement('div');
      column.className = 'col-12 col-md-6';

      const labelEl = document.createElement('label');
      labelEl.className = 'form-label';
      labelEl.textContent = label;
      column.append(labelEl);

      if (hidePrefilled && currentValue) {
        const display = document.createElement('div');
        display.className = 'form-control-plaintext';
        display.textContent = currentValue;
        column.append(display);
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `metadata_${key}`;
        hiddenInput.value = currentValue;
        column.append(hiddenInput);
      } else {
        const input = document.createElement('input');
        input.className = 'form-control';
        input.name = `metadata_${key}`;
        input.placeholder = placeholder;
        input.value = currentValue;
        input.autocomplete = 'off';
        if (field.options_key) {
          const datalist = ensureMetadataOptions(field.options_key);
          if (datalist) {
            input.setAttribute('list', datalist.id);
          }
        }
        if (required) {
          input.required = true;
        }
        column.append(input);
      }

      containerEl.append(column);
    });
  }

  function collectMetadata(containerEl, schema) {
    const metadata = {};
    const missing = [];
    if (!containerEl || !Array.isArray(schema)) {
      return { metadata, missing };
    }
    schema.forEach((field) => {
      const key = field.key;
      const label = field.label || key;
      const input = containerEl.querySelector(`[name="metadata_${key}"]`);
      if (!input) {
        return;
      }
      const value = (input.value || '').trim();
      if (!value && field.required) {
        missing.push(label);
      }
      if (value) {
        metadata[key] = value;
      }
    });
    return { metadata, missing };
  }

  function updateFaultyCounter() {
    if (!faultyCounter) return;
    const faultyTotal = Array.from(stockMap.values()).filter((item) => item.status === 'arizali').length;
    faultyCounter.textContent = faultyTotal;
  }

  function renderStockActionMetadata({ hidePrefilled = false } = {}) {
    if (!actionMetadataSection || !actionMetadataContainer || !pendingStockAction) {
      if (actionMetadataSection) {
        actionMetadataSection.classList.add('d-none');
      }
      return;
    }
    const category = pendingStockAction.category || '';
    const schema = getMetadataSchema(category);
    const defaults = pendingStockAction.metadataDefaults || {};
    const currentValues = readMetadataValues(actionMetadataContainer);
    const values = { ...defaults, ...currentValues };
    buildMetadataForm(actionMetadataSection, actionMetadataContainer, schema, values, {
      hidePrefilled,
      mode: 'assignment',
    });
    if (!Array.isArray(schema) || !schema.length) {
      actionMetadataSection.classList.add('d-none');
      actionMetadataContainer.classList.add('d-none');
      return;
    }
    actionMetadataContainer.classList.remove('d-none');
    if (actionMetadataError) {
      actionMetadataError.classList.add('d-none');
      actionMetadataError.textContent = '';
    }
  }

  function showActionAlert(message, variant = 'success') {
    if (!stockActionAlert) return;
    stockActionAlert.textContent = message;
    stockActionAlert.className = `alert stock-action-alert alert-${variant}`;
    stockActionAlert.classList.remove('d-none');
    if (alertTimeoutId) {
      clearTimeout(alertTimeoutId);
    }
    alertTimeoutId = window.setTimeout(() => stockActionAlert.classList.add('d-none'), 3500);
  }

  function buildStockRow(item) {
    const row = document.createElement('tr');
    row.className = 'stock-row';
    row.dataset.stockId = String(item.id);
    row.dataset.category = item.category;
    row.dataset.status = item.status;
    row.dataset.search = item.search_index || '';
    const hardwareLabel = item.hardware_type || item.title;
    const brandParts = [];
    if (item.brand) brandParts.push(item.brand);
    if (item.model) brandParts.push(item.model);
    let brandLabel = brandParts.join(' ').trim();
    if (!brandLabel && item.title && item.title !== hardwareLabel) {
      brandLabel = item.title;
    }
    const detailParts = [];
    if (brandLabel) detailParts.push(brandLabel);
    if (item.inventory_no) detailParts.push(item.inventory_no);
    const detailText = detailParts.length ? detailParts.join(' • ') : '—';
    row.innerHTML = `
      <td>
        <div class="fw-semibold">${safeText(hardwareLabel)}</div>
        <div class="text-muted small">${safeText(detailText)}</div>
      </td>
      <td><span class="badge bg-soft-primary text-primary">${safeText(item.category_label)}</span></td>
      <td>
        <div class="fw-semibold">${safeText(item.quantity)}</div>
        <div class="text-muted small">${safeText(item.unit)}</div>
      </td>
      <td>
        <div class="fw-semibold">${safeText(item.source_label)}</div>
        <div class="text-muted small">${safeText(item.metadata?.factory || '')}</div>
      </td>
      <td><span class="stock-status-badge ${safeText(item.status_class)}">${safeText(item.status_label)}</span></td>
      <td>
        <div class="fw-semibold">${safeText(item.created_display)}</div>
        <div class="text-muted small">${safeText(item.updated_display)}</div>
      </td>
      <td class="text-end">
        <div class="d-inline-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary btn-sm icon-button stock-detail-trigger" type="button" data-stock-id="${item.id}">
            <i class="bi bi-eye"></i>
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">İşlemler</button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm">
              <li><button class="dropdown-item stock-action" type="button" data-action="assign" data-stock-id="${item.id}" ${item.allow_operations ? '' : 'disabled'}>Atama Yap</button></li>
              <li><button class="dropdown-item stock-action" type="button" data-action="faulty" data-stock-id="${item.id}" ${item.allow_operations ? '' : 'disabled'}>Arızalı İşaretle</button></li>
              <li><button class="dropdown-item text-danger stock-action" type="button" data-action="scrap" data-stock-id="${item.id}" ${item.allow_operations ? '' : 'disabled'}>Hurda</button></li>
            </ul>
          </div>
        </div>
      </td>
    `;
    attachRowEvents(row);
    return row;
  }

  function attachRowEvents(row) {
    const detailButton = row.querySelector('.stock-detail-trigger');
    if (detailButton) {
      detailButton.addEventListener('click', () => {
        const id = Number(row.dataset.stockId);
        const item = stockMap.get(id);
        if (!item || !detailModal) return;
        activeStockId = id;
        const hardwareLabel = item.hardware_type || item.title;
        const brandParts = [];
        if (item.brand) brandParts.push(item.brand);
        if (item.model) brandParts.push(item.model);
        let brandLabel = brandParts.join(' ').trim();
        if (!brandLabel && item.title && item.title !== hardwareLabel) {
          brandLabel = item.title;
        }
        if (detailFields.hardware) {
          detailFields.hardware.textContent = safeText(hardwareLabel);
        }
        if (detailFields.brandModel) {
          detailFields.brandModel.textContent = safeText(brandLabel);
        }
        if (detailFields.category) {
          detailFields.category.textContent = safeText(item.category_label);
        }
        if (detailFields.quantity) {
          detailFields.quantity.textContent = `${safeText(item.quantity)} ${safeText(item.unit)}`;
        }
        if (detailFields.status) {
          detailFields.status.textContent = safeText(item.status_label);
          detailFields.status.className = `stock-status-badge ${item.status_class}`;
        }
        if (detailFields.source) {
          detailFields.source.textContent = safeText(item.source_label);
        }
        if (detailFields.inventory) {
          detailFields.inventory.textContent = safeText(item.inventory_no);
        }
        if (detailFields.department) {
          detailFields.department.textContent = safeText(item.metadata?.department || '');
        }
        if (detailFields.note) {
          detailFields.note.textContent = safeText(item.note);
        }
        if (detailFields.subtitle) {
          detailFields.subtitle.textContent = `${safeText(item.created_display)} · ${safeText(item.updated_display)}`;
        }
        detailModal.show();
      });
    }

    row.querySelectorAll('.stock-action').forEach((button) => {
      button.addEventListener('click', () => {
        const action = button.dataset.action;
        const id = Number(button.dataset.stockId);
        const item = stockMap.get(id);
        if (!item || !actionModal) {
          return;
        }
        activeStockId = id;
        const titles = {
          assign: 'Atama Yap',
          faulty: 'Arızalı İşaretle',
          scrap: 'Hurda İşlemi',
        };
        const messages = {
          assign: 'Seçili stok kaydı envantere geri kazandırılacak.',
          faulty: 'Stok kaydı arızalı olarak işaretlenecek.',
          scrap: 'Bu stok kaydı hurda listesine taşınacak.',
        };
        actionModalEl.dataset.action = action;
        const metadataDefaults = {
          ...(item.metadata || {}),
        };
        if (!metadataDefaults.hardware_type && item.hardware_type) {
          metadataDefaults.hardware_type = item.hardware_type;
        }
        if (!metadataDefaults.brand && item.brand) {
          metadataDefaults.brand = item.brand;
        }
        if (!metadataDefaults.model && item.model) {
          metadataDefaults.model = item.model;
        }
        if (!metadataDefaults.inventory_no && item.inventory_no) {
          metadataDefaults.inventory_no = item.inventory_no;
        }

        pendingStockAction = {
          action,
          category: item.category || '',
          metadataDefaults,
        };

        if (actionTitle) actionTitle.textContent = `${titles[action] || 'İşlem'} · ${safeText(item.hardware_type || item.title)}`;
        if (actionMessage) actionMessage.textContent = messages[action] || '';
        if (actionConfirmButton) {
          actionConfirmButton.textContent = titles[action] || 'Onayla';
          actionConfirmButton.classList.toggle('btn-danger', action === 'scrap');
          actionConfirmButton.classList.toggle('btn-primary', action !== 'scrap');
        }
        if (actionNoteInput) actionNoteInput.value = '';
        if (actionCategoryBadge) {
          actionCategoryBadge.textContent = safeText(item.category_label || '');
        }
        if (action === 'assign') {
          renderStockActionMetadata({ hidePrefilled: true });
          if (actionMetadataSection) {
            actionMetadataSection.classList.remove('d-none');
          }
        } else {
          pendingStockAction = null;
          if (actionMetadataSection) {
            actionMetadataSection.classList.add('d-none');
          }
          if (actionMetadataContainer) {
            actionMetadataContainer.innerHTML = '';
          }
          if (actionMetadataError) {
            actionMetadataError.classList.add('d-none');
            actionMetadataError.textContent = '';
          }
        }
        actionModal.show();
      });
    });
  }

  function renderStockTable() {
    if (!stockTableBody) return;
    stockTableBody.innerHTML = '';
    if (!stockMap.size) {
      stockTableBody.innerHTML = '<tr><td class="text-center text-muted" colspan="7">Stok kaydı bulunamadı.</td></tr>';
      return;
    }
    const fragment = document.createDocumentFragment();
    Array.from(stockMap.values())
      .sort((a, b) => b.id - a.id)
      .forEach((item) => fragment.appendChild(buildStockRow(item)));
    stockTableBody.appendChild(fragment);
    rebuildUserAssignments();
    if (pagination && stockTableEl) {
      pagination.refresh(stockTableEl);
    }
  }

  function renderLogTable() {
    if (!stockLogTableBody) return;
    stockLogTableBody.innerHTML = '';
    if (!stockLogs.length) {
      stockLogTableBody.innerHTML = '<tr><td class="text-center text-muted" colspan="6">Henüz log kaydı bulunmuyor.</td></tr>';
      return;
    }
    const fragment = document.createDocumentFragment();
    stockLogs.forEach((log) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div class="fw-semibold">${safeText(log.action)}</div>
        </td>
        <td>${safeText(log.performed_by)}</td>
        <td>
          <div class="fw-semibold">${safeText(log.title)}</div>
          <div class="text-muted small">${safeText(log.metadata?.inventory_no || '')}</div>
        </td>
        <td><span class="stock-status-badge ${safeText(log.status_class || '')}">${safeText(log.status_label)}</span></td>
        <td>${safeText(log.created_display)}</td>
        <td>${safeText(log.note)}</td>
      `;
      fragment.appendChild(row);
    });
    stockLogTableBody.appendChild(fragment);
    if (pagination && stockLogTableEl) {
      pagination.refresh(stockLogTableEl);
    }
  }

  function refreshAssignmentSelect(previousValue = '') {
    if (!stockUserSelect) {
      return;
    }
    const preservedValue = previousValue || stockUserSelect.value || '';
    const sortedNames = Array.from(userAssignments.keys()).sort((a, b) => a.localeCompare(b, 'tr-TR'));
    stockUserSelect.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Kullanıcı seçin';
    stockUserSelect.appendChild(placeholder);
    sortedNames.forEach((name) => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      stockUserSelect.appendChild(option);
    });
    if (preservedValue && userAssignments.has(preservedValue)) {
      stockUserSelect.value = preservedValue;
    } else {
      stockUserSelect.value = '';
    }
  }

  function renderUserAssignments(responsibleName = '') {
    if (!stockUserTableBody) {
      return;
    }
    const tableEl = stockUserTableEl;
    stockUserTableBody.innerHTML = '';
    const name = responsibleName && userAssignments.has(responsibleName) ? responsibleName : '';
    if (!name) {
      const row = document.createElement('tr');
      row.dataset.emptyRow = 'true';
      row.innerHTML = `<td class="text-muted text-center" colspan="5">${responsibleName ? 'Bu kullanıcıya ait stok kaydı bulunamadı.' : 'Bir kullanıcı seçin.'}</td>`;
      stockUserTableBody.appendChild(row);
      if (pagination && tableEl) {
        pagination.refresh(tableEl);
      }
      return;
    }
    const items = userAssignments.get(name) || [];
    if (!items.length) {
      const row = document.createElement('tr');
      row.dataset.emptyRow = 'true';
      row.innerHTML = '<td class="text-muted text-center" colspan="5">Bu kullanıcıya ait stok kaydı bulunamadı.</td>';
      stockUserTableBody.appendChild(row);
      if (pagination && tableEl) {
        pagination.refresh(tableEl);
      }
      return;
    }
    const fragment = document.createDocumentFragment();
    items.forEach((item) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${safeText(item.hardware_type)}</td>
        <td><span class="badge bg-light text-dark">${safeText(item.category_label)}</span></td>
        <td>${safeText(item.quantity)}</td>
        <td><span class="stock-status-badge ${safeText(item.status_class || '')}">${safeText(item.status_label)}</span></td>
        <td>${safeText(item.updated_display || '')}</td>
      `;
      fragment.appendChild(row);
    });
    stockUserTableBody.appendChild(fragment);
    if (pagination && tableEl) {
      pagination.refresh(tableEl);
    }
  }

  function rebuildUserAssignments() {
    const previousSelection = stockUserSelect ? stockUserSelect.value : '';
    userAssignments.clear();
    stockMap.forEach((item) => {
      if (!item || item.status !== 'devredildi') {
        return;
      }
      const responsibleName = (item.metadata?.responsible || '').trim();
      if (!responsibleName) {
        return;
      }
      if (!userAssignments.has(responsibleName)) {
        userAssignments.set(responsibleName, []);
      }
      userAssignments.get(responsibleName).push({
        id: item.id,
        hardware_type: item.hardware_type || item.title,
        category_label: item.category_label,
        quantity: item.quantity,
        status_label: item.status_label,
        status_class: item.status_class,
        updated_display: item.updated_display,
      });
    });
    refreshAssignmentSelect(previousSelection);
    const activeSelection = stockUserSelect ? stockUserSelect.value : '';
    renderUserAssignments(activeSelection);
  }

  function filterStock() {
    if (!stockTableBody) return;
    const query = stockSearchInput ? stockSearchInput.value.trim().toLowerCase() : '';
    const categoryInput = stockCategoryFilters?.querySelector('input[name="stockCategory"]:checked');
    const category = categoryInput ? categoryInput.value : 'all';
    let visibleCount = 0;
    stockTableBody.querySelectorAll('.stock-row').forEach((row) => {
      const item = stockMap.get(Number(row.dataset.stockId));
      if (!item) {
        row.classList.add('d-none');
        return;
      }
    const matchesQuery = !query || (row.dataset.search || '').includes(query);
    const matchesCategory = category === 'all' || row.dataset.category === category;
    const matchesFaulty = !showOnlyFaulty || row.dataset.status === 'arizali';
    const matchesStatus = includeNonStock || row.dataset.status === 'stokta';
    const shouldShow = matchesQuery && matchesCategory && matchesFaulty && matchesStatus;
    if (shouldShow) {
      delete row.dataset.searchHidden;
      visibleCount += 1;
    } else {
      row.dataset.searchHidden = 'true';
    }
    row.classList.toggle('d-none', !shouldShow);
  });
  if (stockEmptyState) {
    stockEmptyState.classList.toggle('d-none', visibleCount > 0);
  }
  if (pagination && stockTableEl) {
    pagination.refresh(stockTableEl);
  }
}

  async function sendStockRequest(url, { method = 'POST', body = null } = {}) {
    const options = { method, headers: { 'Content-Type': 'application/json' } };
    if (body && method !== 'GET') {
      options.body = JSON.stringify(body);
    }
    try {
      const response = await fetch(url, options);
      let payload = {};
      try {
        payload = await response.json();
      } catch (error) {
        payload = {};
      }
      if (!response.ok) {
        throw new Error(payload.error || 'İşlem tamamlanamadı.');
      }
      return payload;
    } catch (error) {
      showActionAlert(error.message || 'Sunucuya ulaşılamadı.', 'danger');
      throw error;
    }
  }

  function applyStockDetail(item) {
    stockMap.set(item.id, item);
    renderStockTable();
    updateFaultyCounter();
    filterStock();
  }

  function appendStockLog(log) {
    if (!log) return;
    stockLogs.unshift(log);
    if (stockLogs.length > 40) {
      stockLogs.pop();
    }
    renderLogTable();
  }

  if (faultyButton) {
    faultyButton.addEventListener('click', () => {
      showOnlyFaulty = !showOnlyFaulty;
      faultyButton.classList.toggle('btn-warning', !showOnlyFaulty);
      faultyButton.classList.toggle('btn-danger', showOnlyFaulty);
      filterStock();
    });
  }

  if (historyToggle) {
    historyToggle.addEventListener('click', () => {
      includeNonStock = !includeNonStock;
      historyToggle.classList.toggle('btn-outline-secondary', !includeNonStock);
      historyToggle.classList.toggle('btn-secondary', includeNonStock);
      filterStock();
    });
  }

  if (stockCategoryFilters) {
    stockCategoryFilters.addEventListener('change', filterStock);
  }

  if (stockSearchInput) {
    stockSearchInput.addEventListener('input', filterStock);
  }

  if (stockUserSelect) {
    stockUserSelect.addEventListener('change', () => {
      renderUserAssignments(stockUserSelect.value);
    });
  }

  function renderCreateMetadataFields() {
    if (!createCategorySelect) {
      return;
    }
    const selectedCategory = createCategorySelect.value || '';
    const schema = getMetadataSchema(selectedCategory);
    const values = readMetadataValues(createMetadataFields);
    buildMetadataForm(createMetadataSection, createMetadataFields, schema, values, { mode: 'entry' });
    if (createMetadataError) {
      createMetadataError.classList.add('d-none');
      createMetadataError.textContent = '';
    }
  }

  if (createCategorySelect) {
    createCategorySelect.addEventListener('change', () => {
      renderCreateMetadataFields();
    });
  }

  if (actionForm && actionModalEl) {
    actionForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const action = actionModalEl.dataset.action;
      const item = stockMap.get(activeStockId);
      if (!action || !item) {
        return;
      }
      const note = actionNoteInput ? actionNoteInput.value.trim() : '';
      const endpoints = {
        assign: `/api/stock/${item.id}/assign`,
        faulty: `/api/stock/${item.id}/mark-faulty`,
        scrap: `/api/stock/${item.id}/scrap`,
      };
      const url = endpoints[action];
      if (!url) {
        return;
      }
      const requestBody = { note, performed_by: defaultActor };
      if (action === 'assign') {
        const schema = getMetadataSchema(item.category);
        const { metadata, missing } = collectMetadata(actionMetadataContainer, schema);
        if (missing.length) {
          if (actionMetadataError) {
            actionMetadataError.textContent = `${missing.join(', ')} alanlarını doldurun.`;
            actionMetadataError.classList.remove('d-none');
          }
          return;
        }
        if (actionMetadataError) {
          actionMetadataError.classList.add('d-none');
          actionMetadataError.textContent = '';
        }
        if (Object.keys(metadata).length) {
          requestBody.metadata = metadata;
        }
      }
      try {
        const payload = await sendStockRequest(url, {
          body: requestBody,
        });
        if (payload?.stock_item) {
          stockMap.set(payload.stock_item.id, payload.stock_item);
          renderStockTable();
          updateFaultyCounter();
          filterStock();
        }
        if (payload?.log) {
          appendStockLog(payload.log);
        }
        showActionAlert('İşlem başarıyla kaydedildi.', 'success');
        actionModal?.hide();
      } catch (error) {
        // alert already shown
      }
    });
  }

  if (actionModalEl) {
    actionModalEl.addEventListener('hidden.bs.modal', () => {
      pendingStockAction = null;
      if (actionMetadataContainer) {
        actionMetadataContainer.innerHTML = '';
      }
      if (actionMetadataSection) {
        actionMetadataSection.classList.add('d-none');
      }
      if (actionMetadataError) {
        actionMetadataError.classList.add('d-none');
        actionMetadataError.textContent = '';
      }
      if (actionCategoryBadge) {
        actionCategoryBadge.textContent = '';
      }
    });
  }

  if (createForm) {
    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const payload = {
        title: createTitleInput?.value.trim(),
        category: createCategorySelect?.value,
        quantity: Number(createQuantityInput?.value || 1),
        unit: createUnitInput?.value.trim(),
        note: createNoteInput?.value.trim(),
        performed_by: defaultActor,
      };
      if (!payload.title) {
        createTitleInput?.reportValidity();
        return;
      }
      if (!Number.isFinite(payload.quantity) || payload.quantity < 1) {
        if (createQuantityInput) {
          createQuantityInput.value = '1';
          createQuantityInput.focus();
        }
        showActionAlert('Miktar en az 1 olmalıdır.', 'danger');
        return;
      }
      const schema = getMetadataSchema(payload.category);
      const { metadata, missing } = collectMetadata(createMetadataFields, schema);
      if (missing.length) {
        if (createMetadataError) {
          createMetadataError.textContent = `${missing.join(', ')} alanlarını doldurun.`;
          createMetadataError.classList.remove('d-none');
        }
        return;
      }
      if (createMetadataError) {
        createMetadataError.classList.add('d-none');
        createMetadataError.textContent = '';
      }
      payload.metadata = metadata;
      try {
        const response = await sendStockRequest('/api/stock', { body: payload });
        if (response?.stock_item) {
          stockMap.set(response.stock_item.id, response.stock_item);
          renderStockTable();
          updateFaultyCounter();
          filterStock();
        }
        if (response?.log) {
          appendStockLog(response.log);
        }
        showActionAlert('Yeni stok kaydı oluşturuldu.', 'success');
        createForm.reset();
        renderCreateMetadataFields();
        if (createModalEl && bootstrapLib) {
          bootstrapLib.Modal.getInstance(createModalEl)?.hide();
        }
      } catch (error) {
        // error shown
      }
    });
  }

  renderStockTable();
  renderLogTable();
  renderCreateMetadataFields();
  rebuildUserAssignments();
  filterStock();
  updateFaultyCounter();
</script>
{% endblock %}
